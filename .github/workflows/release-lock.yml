name: Release Lock

on:
  workflow_dispatch:
    inputs:
      desired-environment:
        type: choice
        description: Environment you want to release lock from
        required: true
        options:
          - test
          - dev
          - prod
          - commons
      lock-id:
        type: string
        description: ID of the lock to be released
        required: true

env:
  TF_VERSION: 1.4.6
  AWS_DEFAULT_REGION: "eu-west-1"

jobs:
  release-lock:
    name: Force releasing Lock in ${{ inputs.desired-environment }}
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: ${{ inputs.desired-environment }}
      LOCK_ID: ${{ inputs.lock-id }}
    steps:
      - name: Get the code (Checkout)
        uses: actions/checkout@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Get to Working directory
        id: get_work_dir
        run: |
          wd_var='./terraform/${{ env.ENVIRONMENT }}'
          echo "working_directory=$wd_var" >> "$GITHUB_OUTPUT"

      - name: Check Working directory
        run: echo ${{steps.get_work_dir.outputs.working_directory}}

      - name: Run Terraform
        run: |
          terraform init
          terraform force-unlock -force ${{ inputs.LOCK_ID }}
        working-directory: ${{steps.get_work_dir.outputs.working_directory}}
